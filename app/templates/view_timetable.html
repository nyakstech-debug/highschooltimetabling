{% extends "base.html" %}

{% block title %}Block Timetable View - SchoolTimetable{% endblock %}

{% block content %}
<style>
    .timetable-container {
        overflow-x: auto;
        margin: 20px 0;
    }
    
    .block-timetable {
        width: 100%;
        border-collapse: collapse;
        font-family: Arial, sans-serif;
        background-color: white;
        font-size: 11px;
    }
    
    .block-timetable th, .block-timetable td {
        border: 1px solid #333;
        padding: 4px;
        text-align: center;
        vertical-align: middle;
        height: 30px;
    }
    
    .block-timetable th {
        background-color: #cccccc;
        font-weight: bold;
        height: auto;
        padding: 8px 4px;
    }
    
    .time-header {
        background-color: #999;
        color: white;
        font-weight: bold;
        font-size: 9px;
        max-width: 60px;
    }
    
    .day-label {
        font-weight: bold;
        background-color: #ddd;
        font-size: 12px;
        min-width: 80px;
        writing-mode: vertical-rl;
        text-orientation: mixed;
        transform: rotate(180deg);
    }
    
    .class-label {
        background-color: #e8e8e8;
        font-size: 10px;
        font-weight: bold;
        padding: 2px;
        text-align: left;
    }
    
    .lesson-cell {
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        padding: 2px;
        font-size: 10px;
        line-height: 1.2;
    }
    
    .lesson-code {
        font-weight: bold;
        color: #0066cc;
        font-size: 11px;
    }
    
    .lesson-teacher {
        color: #666;
        font-size: 9px;
    }
    
    .empty-cell {
        background-color: #ffffff;
    }
    
    .title-section {
        margin-bottom: 20px;
    }
    
    .timetable-info {
        margin-bottom: 15px;
        padding: 10px;
        background-color: #f9f9f9;
        border-left: 4px solid #0066cc;
    }
    
    .quick-access {
        margin-top: 30px;
        padding: 15px;
        background-color: #f5f5f5;
        border-radius: 4px;
    }
    
    .button-group {
        margin-top: 20px;
        margin-bottom: 30px;
    }
    
    @media print {
        body {
            margin: 0;
            padding: 10px;
        }
        .btn, .quick-access {
            display: none !important;
        }
        .timetable-container {
            page-break-inside: avoid;
        }
        .block-timetable {
            width: 100%;
            margin-top: 10px;
            font-size: 9px;
        }
        .block-timetable th, .block-timetable td {
            padding: 3px;
            height: 25px;
            border: 1px solid #333;
        }
        .title-section h2 {
            margin-top: 0;
            font-size: 16px;
        }
        .timetable-info {
            margin-bottom: 10px;
            font-size: 11px;
        }
    }
</style>

<div class="title-section">
    <h2>School Block Timetable - All Classes</h2>
    <div class="timetable-info">
        <strong>Generated:</strong> {{ timetable.generated_at.strftime('%Y-%m-%d %H:%M') }} | 
        <strong>Total Lessons:</strong> {{ timetable.lessons|length }}
    </div>
</div>

<div class="timetable-container">
    <table class="block-timetable">
        <thead>
            <tr>
                <th colspan="2" style="background-color: #ddd;"></th>
                {% set periods = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10] %}
                {% for period in periods %}
                <th class="time-header">
                    P{{ period }}<br>
                    {% if period == 1 %}08:20-09:00
                    {% elif period == 2 %}09:00-09:40
                    {% elif period == 3 %}09:40-10:20
                    {% elif period == 4 %}10:20-11:00
                    {% elif period == 5 %}11:00-11:40
                    {% elif period == 6 %}11:40-12:20
                    {% elif period == 7 %}12:20-13:00
                    {% elif period == 8 %}14:00-14:40
                    {% elif period == 9 %}14:40-15:20
                    {% elif period == 10 %}15:20-16:00
                    {% endif %}
                </th>
                {% endfor %}
                <th style="background-color: #ddd;"></th>
            </tr>
        </thead>
        <tbody>
            {% set days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'] %}
            {% set periods = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10] %}
            {% set classes = current_user.classes|sort(attribute='level') %}
            
            {% for day in days %}
                {% for class_obj in classes %}
                <tr>
                    {% if loop.first %}
                    <td rowspan="{{ classes|length }}" class="day-label">{{ day }}</td>
                    {% endif %}
                    
                    <td class="class-label">{{ class_obj.level }}<br>{{ class_obj.name }}</td>
                    
                    {% for period in periods %}
                        {% set lesson = timetable.lessons|selectattr('class_id', 'equalto', class_obj.id)|selectattr('time_slot')|selectattr('time_slot.period', 'equalto', period)|list|first %}
                        <td class="{% if lesson %}lesson-cell{% else %}empty-cell{% endif %}">
                            {% if lesson %}
                                <div class="lesson-code">{{ lesson.subject.code }}</div>
                                <div class="lesson-teacher">{{ lesson.teacher.name|truncate(10, True) }}</div>
                            {% endif %}
                        </td>
                    {% endfor %}
                    
                    <td style="background-color: #ddd; font-size: 10px; font-weight: bold;">
                        {{ class_obj.level }}
                    </td>
                </tr>
                {% endfor %}
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="button-group">
    <button class="btn btn-primary" onclick="window.print()">Print Block Timetable</button>
    <a href="{{ url_for('timetable.list_timetables') }}" class="btn btn-secondary">Back to Timetables</a>
</div>

<div class="quick-access">
    <h5>View Individual Timetables</h5>
    
    <div style="margin-bottom: 15px;">
        <h6>Classes</h6>
        {% for class_obj in current_user.classes|sort(attribute='level') %}
        <a href="{{ url_for('timetable.class_timetable', timetable_id=timetable.id, class_id=class_obj.id) }}" class="btn btn-sm btn-outline-primary" style="margin: 5px 5px 5px 0;">
            {{ class_obj.level }} {{ class_obj.name }}
        </a>
        {% endfor %}
    </div>
    
    <div>
        <h6>Teachers</h6>
        {% for teacher in current_user.teachers|sort(attribute='name') %}
        <a href="{{ url_for('timetable.teacher_timetable', timetable_id=timetable.id, teacher_id=teacher.id) }}" class="btn btn-sm btn-outline-primary" style="margin: 5px 5px 5px 0;">
            {{ teacher.name }}
        </a>
        {% endfor %}
    </div>
</div>
{% endblock %}
